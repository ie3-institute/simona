task checkBranchName {
  doLast {
    def branchName = System.getenv('GITHUB_REF_NAME')
    def eventName = System.getenv('GITHUB_EVENT_NAME')
    def headRef = System.getenv('GITHUB_HEAD_REF')

    if (eventName == 'pull_request') {
      branchName = headRef
    }

    if (branchName.startsWith('refs/heads/')) {
      branchName = branchName.replaceFirst('refs/heads/', '')
    }

    def pattern = /^[a-z]{2}\/#([0-9]+)(-.*)?$/
    if (!branchName.matches(pattern)) {
      throw new GradleException("Error: Branch name must start with two lowercase initials (e.g., ps/#1337-FeatureName).")
    }

    println "Branch name is $branchName"
    project.ext.set('branch_name', branchName)
  }
}